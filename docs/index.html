<!DOCTYPE html>
<html>

<body>
    <div id="player"></div>

    <script>
        const audioChannel = new BroadcastChannel('youtubeAudioDataChannel');
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        let player;
        const vid = 'M7lc1UVf-VE';
        const obj = new THREE.Mesh();
        obj.material = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            wireframe: true
        });

        const onYouTubeIframeAPIReady = () => {
            player = new YT.Player('player', {
                height: 200,
                width: 200,
                videoId: vid,
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange
                }
            });
        }

        const onPlayerReady = (event) => {
            audioChannel.postMessage({
                type: 'ready',
                vid: vid
            });
            event.target.playVideo();
            DrawGraph();
        }

        const onPlayerStateChange = (event) => {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                //
            }
        }

        const stopVideo = () => {
            player.stopVideo();
        }

        const DrawGraph = () => {
            var data = new Uint8Array(512);
            scene.remove(obj);
            audioChannel.postMessage({
                type: 'get audio data'
            });
            requestAnimationFrame(DrawGraph);
        }

        audioChannel.onmessage = (evt) => {
            const msg = evt.data
            if (msg.type === 'audio-data') {
                const data = data.audioData;
                obj.geometry.dispose();
                obj.geometry = new THREE.TorusKnotGeometry( //小数をかけてるのは値を小さくして、3Dオブジェクトのサイズを小さくするため
                    Math.round(data[0] * 2.0), //全体的な大きさ
                    Math.round(data[1] * 0.3), //チューブの太さ
                    Math.round(40), //クネクネの進む方向に対してなん分割するか
                    Math.round(8), //チューブ方向に何分割するか
                    Math.round(data[2] * 0.3), //なんかクネクネ具合が変わる数値その1
                    Math.round(2) //なんかクネクネ具合が変わる数値その2
                );
            }
        }
    </script>
</body>

</html>
